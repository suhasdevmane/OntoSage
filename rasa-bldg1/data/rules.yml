version: "3.1"
rules:

  - rule: Route brickbot questions to action
    steps:
      - intent: Questions_to_brickbot
      - action: action_question_to_brickbot
    wait_for_user_input: false

  - rule: Respond to greetings
    steps:
      - intent: greet
      - action: utter_greet

  - rule: Test file sharing action
    steps:
      - intent: test_action_server
      - action: action_generate_and_share_data

  - rule: Say goodbye anytime the user says goodbye
    steps:
      - intent: goodbye
      - action: utter_goodbye

  - rule: Say 'I am a bot' anytime the user challenges
    steps:
      - intent: bot_challenge
      - action: utter_iamabot

  - rule: Cheer up unhappy users
    steps:
      - intent: mood_unhappy
      - action: utter_cheer_up

  - rule: Acknowledge happy users
    steps:
      - intent: mood_great
      - action: utter_happy

  # Removed automatic activation of sensor_form on Questions_to_brickbot.
  # Now the intent will be handled by a story that calls action_question_to_brickbot first.

  - rule: Submit sensor form and process SPARQL query
    condition:
      - active_loop: sensor_form
    steps:
      - action: sensor_form
      - active_loop: null
      - action: action_question_to_brickbot
      # Follow-up actions are handled by dedicated rules based on slots

  - rule: Handle SPARQL error
    condition:
      - slot_was_set:
          - sparql_error: true
    steps:
      - action: utter_translation_error
      - action: action_reset_slots

  - rule: Handle no timeseries IDs
    condition:
      - slot_was_set:
          - sparql_error: false
      - slot_was_set:
          - timeseries_ids: null
    steps:
      - action: utter_no_dates_needed
      - action: action_reset_slots

  - rule: Activate date range choice form when dates are needed
    condition:
      - slot_was_set:
          - sparql_error: false
      - slot_was_set:
          - timeseries_ids
      - slot_was_set:
          - start_date: null
      - slot_was_set:
          - end_date: null
      - slot_was_set:
          - date_range_mode: null
    steps:
      - action: date_range_choice_form
      - active_loop: date_range_choice_form

  - rule: Submit date range choice form
    condition:
      - active_loop: date_range_choice_form
    steps:
      - action: date_range_choice_form
      - active_loop: null
      - action: action_route_after_date_choice
    wait_for_user_input: false

  - rule: Submit dates form
    condition:
      - active_loop: dates_form
      - slot_was_set:
          - start_date: any
      - slot_was_set:
          - end_date: any
    steps:
      - action: dates_form
      - active_loop: null
      - action: action_process_timeseries
      - action: action_reset_slots

  - rule: Handle invalid sensor correction
    condition:
      - active_loop: sensor_form
      - slot_was_set:
          - sensor_type: null
    steps:
      - action: utter_ask_sensor_type

  - rule: Handle invalid start date
    condition:
      - active_loop: dates_form
      - slot_was_set:
          - start_date: null
    steps:
      - action: utter_ask_start_date

  - rule: Handle invalid end date
    condition:
      - active_loop: dates_form
      - slot_was_set:
          - start_date: any
          - end_date: null
    steps:
      - action: utter_ask_end_date

