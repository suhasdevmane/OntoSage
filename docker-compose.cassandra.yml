# Option 3: ThingsBoard + PostgreSQL (entities) + Cassandra (telemetry)
# Quick start (PowerShell):
#   docker compose -f docker-compose.cassandra.yml up -d --build
#   docker compose -f docker-compose.cassandra.yml down

services:
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    hostname: postgres
    environment:
      POSTGRES_DB: ${PG_THINGSBOARD_DB:-thingsboard}
      POSTGRES_USER: ${PG_THINGSBOARD_USER:-thingsboard}
      POSTGRES_PASSWORD: ${PG_THINGSBOARD_PASSWORD:-thingsboard}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - ontobot-network

  cassandra:
    image: thingsboard/tb-cassandra:4.2.0
    container_name: cassandra
    hostname: cassandra
    environment:
      CASSANDRA_CLUSTER_NAME: "ThingsBoard Cluster"
      CASSANDRA_DC: "DC1"
      CASSANDRA_RACK: "RAC1"
      CASSANDRA_ENDPOINT_SNITCH: "GossipingPropertyFileSnitch"
      CASSANDRA_START_RPC: "true"
    ports:
      - "9042:9042"
    volumes:
      - cassandra-data:/var/lib/cassandra
    networks:
      - ontobot-network

  mytb:
    image: devmanenvision/my-thingsboard-cassandra:1.1
    container_name: thingsboard
    hostname: thingsboardhost
    depends_on:
      - postgres
      - cassandra
    environment:
      TB_QUEUE_TYPE: in-memory
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/${PG_THINGSBOARD_DB:-thingsboard}
      SPRING_DATASOURCE_USERNAME: ${PG_THINGSBOARD_USER:-thingsboard}
      SPRING_DATASOURCE_PASSWORD: ${PG_THINGSBOARD_PASSWORD:-thingsboard}
      DATABASE_TS_TYPE: cassandra
      CASSANDRA_CONTACT_POINTS: cassandra
      CASSANDRA_PORT: 9042
      CASSANDRA_KEYSPACE_NAME: thingsboard
    ports:
      - "8082:9090"   # TB Web UI at http://localhost:8082
      - "1883:1883"
      - "7070:7070"
      - "5683-5688:5683-5688/udp"
      - "8081:8081"
    volumes:
      - mytb-cass-data:/data
      - mytb-cass-logs:/var/log/thingsboard
    networks:
      - ontobot-network

networks:
  ontobot-network:

volumes:
  postgres-data:
  cassandra-data:
  mytb-cass-data:
  mytb-cass-logs:
