# Quick start (PowerShell):
#   docker compose -f docker-compose.bldg3.yml up -d --build
#   docker compose -f docker-compose.bldg3.yml --profile manual up --build --abort-on-container-exit rasa-train
#   docker compose -f docker-compose.bldg3.yml down
#   # With extras overlay
#   docker compose -f docker-compose.bldg3.yml -f docker-compose.extras.yml up -d --build
#   docker compose -f docker-compose.bldg3.yml -f docker-compose.extras.yml down
# Purpose: Building 3 stack (Rasa at ./rasa-bldg3) + ThingsBoard on Cassandra + shared services.

# Stack for Building 3: Rasa (project at ./rasa-bldg3) + ThingsBoard with Cassandra telemetry

services:
  # PostgreSQL for ThingsBoard metadata (non-time-series)
  postgres:
    image: postgres:13
    container_name: tb_postgres
    hostname: tb_postgres
    environment:
      POSTGRES_DB: ${PG_THINGSBOARD_DB:-thingsboard}
      POSTGRES_USER: ${PG_THINGSBOARD_USER:-thingsboard}
      POSTGRES_PASSWORD: ${PG_THINGSBOARD_PASSWORD:-thingsboard}
    ports:
      - "5434:5432"
    volumes:
      - tb-cs-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U thingsboard -d thingsboard"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - ontobot-network

  # Cassandra for telemetry
  cassandra:
    image: cassandra:4.1
    container_name: cassandra
    hostname: cassandra
    environment:
      - CASSANDRA_CLUSTER_NAME=ThingsBoardCluster
      - CASSANDRA_START_RPC=true
      - MAX_HEAP_SIZE=1G
      - HEAP_NEWSIZE=256M
    ports:
      - "9042:9042"
    volumes:
      - cassandra-data:/var/lib/cassandra
    healthcheck:
      test: ["CMD-SHELL", "nodetool status | grep -q 'UN' "]
      interval: 20s
      timeout: 10s
      retries: 20
      start_period: 120s
    networks:
      - ontobot-network

  mytb:
    image: thingsboard/tb-cassandra:3.6.0
    container_name: thingsboard
    hostname: thingsboardhost
    depends_on:
      postgres:
        condition: service_healthy
      cassandra:
        condition: service_healthy
    environment:
      TB_QUEUE_TYPE: in-memory
      SPRING_DATASOURCE_URL: jdbc:postgresql://tb_postgres:5432/${PG_THINGSBOARD_DB:-thingsboard}
      SPRING_DATASOURCE_USERNAME: ${PG_THINGSBOARD_USER:-thingsboard}
      SPRING_DATASOURCE_PASSWORD: ${PG_THINGSBOARD_PASSWORD:-thingsboard}
      DATABASE_TS_TYPE: cassandra
      # Explicitly set Cassandra host for ThingsBoard to avoid defaulting to localhost
      CASSANDRA_HOST: cassandra
      # ThingsBoard 3.6 uses CASSANDRA_URL (host:port) from thingsboard.yml
      CASSANDRA_URL: "cassandra:9042"
      CASSANDRA_CONTACT_POINTS: cassandra
      CASSANDRA_PORT: 9042
      CASSANDRA_KEYSPACE_NAME: thingsboard
      CASSANDRA_LOCAL_DATACENTER: datacenter1
      # Ensure username/password login is available and OAuth2 is disabled
      SECURITY_OAUTH2_ENABLED: "false"
      SECURITY_USER_LOGIN_ENABLED: "true"
    ports:
      - "8082:9090"   # TB Web UI at http://localhost:8082
      - "1884:1883"
      - "7071:7070"
      - "5689-5694:5683-5688/udp"
      - "8081:8081"   # TB HTTP transport API (default)
    volumes:
      - mytb-cas-data:/data
      - mytb-cas-logs:/var/log/thingsboard
    networks:
      - ontobot-network


  rasa-frontend:
    build:
      context: ./rasa-frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"  # Unified with bldg1/bldg2 since only one stack runs at a time
    volumes:
      - ./rasa-frontend/:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
    container_name: rasa-frontend-bldg3
    hostname: rasa-frontend-host-bldg3
    restart: unless-stopped
    command: npm start
    networks:
      - ontobot-network

  # Rasa services for Building 3
  rasa:
    image: rasa/rasa:3.6.12-full
    container_name: rasa_bldg3
    restart: unless-stopped
    volumes:
      - ./rasa-bldg3/data:/app/data
      - ./rasa-bldg3/domain.yml:/app/domain.yml
      - ./rasa-bldg3/config.yml:/app/config.yml
      - ./rasa-bldg3/endpoints.yml:/app/endpoints.yml
      - ./rasa-bldg3/credentials.yml:/app/credentials.yml
      - ./rasa-bldg3/models:/app/models
      - ./rasa-bldg3/shared_data:/app/shared_data
      - ./rasa-bldg3/start_rasa.sh:/app/start_rasa.sh:ro
    entrypoint: ["bash", "-lc"]
    command: "/app/start_rasa.sh"
    depends_on:
      - action_server
      - duckling_server
    ports:
      - "5005:5005"  # Unified Rasa port
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5005/version').read()"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - ontobot-network

  action_server:
    build: ./rasa-bldg3/actions
    container_name: action_server_bldg3
    restart: unless-stopped
    volumes:
      - ./rasa-bldg3/actions/actions.py:/app/actions.py
      - ./rasa-bldg3/shared_data:/app/shared_data
    environment:
      - BASE_URL=http://http_server:8080
      - DECIDER_URL=http://decider-service:6009/decide
      - BUNDLE_MEDIA=true
      - DB_HOST=${DB_HOST:-mysqlserver}
      - DB_NAME=${DB_NAME:-sensordb}
      - DB_USER=${DB_USER:-root}
      - DB_PASSWORD=${DB_PASSWORD:-mysql}
      - DB_PORT=3306
      - ANALYTICS_URL=http://microservices:6000/analytics/run
    ports:
      - "5055:5055"  # Unified Action Server port
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5055/health').read()"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - ontobot-network
    depends_on:
      - decider-service
      # MySQL service is not defined in this stack; remove dependency to avoid invalid compose project

  duckling_server:
    image: rasa/duckling:latest
    container_name: duckling_server_bldg3
    restart: unless-stopped
    ports:
      - "8000:8000"  # Unified Duckling port
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -s http://localhost:8000 | grep -q Duckling"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - ontobot-network

  rasa-train:
    image: rasa/rasa:3.6.12-full
    container_name: rasa_train_bldg3
    profiles: ["manual"]
    working_dir: /srv/rasa
    user: root
    command:
      - train
      - --config
      - /srv/rasa/config.yml
      - --domain
      - /srv/rasa/domain.yml
      - --data
      - /srv/rasa/data
      - --out
      - /srv/rasa/models
    volumes:
      - ./rasa-bldg3/data:/srv/rasa/data
      - ./rasa-bldg3/domain.yml:/srv/rasa/domain.yml
      - ./rasa-bldg3/config.yml:/srv/rasa/config.yml
      - ./rasa-bldg3/models:/srv/rasa/models
      - ./rasa-bldg3/endpoints.yml:/srv/rasa/endpoints.yml
      - ./rasa-bldg3/credentials.yml:/srv/rasa/credentials.yml
    networks:
      - ontobot-network

  http_server:
    image: python:3.8-slim
    container_name: http_server_bldg3
    restart: unless-stopped
    ports:
      - "8080:8080"  # Unified file server port
    volumes:
      - ./rasa-bldg3/shared_data:/data
      - ./rasa-bldg3/file_server.py:/srv/file_server.py
      - ./rasa-bldg3/start_rasa.sh:/srv/start_rasa.sh:ro
      - ./rasa-bldg3/data:/srv/rasa/data
      - ./rasa-bldg3/domain.yml:/srv/rasa/domain.yml
      - ./rasa-bldg3/config.yml:/srv/rasa/config.yml
      - ./rasa-bldg3/models:/srv/rasa/models
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - ROOT_DIR=/data
      - PORT=8080
      - FRONTEND_ORIGIN=${FRONTEND_ORIGIN:-http://localhost:3001}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3001}
      - JWT_SECRET=${JWT_SECRET:-change_me_in_prod}
      - JWT_EXPIRES_DAYS=7
      - SECURE_COOKIES=false
      - AUTO_LOAD_AFTER_TRAIN=false
      - RASA_HOST=rasa
      - RASA_HTTP_PORT=5005
      - RASA_PROJECT_ROOT=/srv/rasa
    command: ["sh", "-c", "pip install --no-cache-dir flask werkzeug pyjwt requests docker && python3 /srv/file_server.py"]
    healthcheck:
      test: ["CMD", "python", "-c", "import sys,urllib.request; sys.exit(0 if 'ok' in urllib.request.urlopen('http://localhost:8080/health').read().decode() else 1)"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - ontobot-network

  rasa-editor:
    build:
      context: ./rasa-bldg3
      dockerfile: editor.Dockerfile
    container_name: rasa_editor_bldg3
    restart: unless-stopped
    ports:
      - "6080:6080"  # Unified editor port
    environment:
      - PORT=6080
      - FRONTEND_ORIGIN=http://localhost:3001
      - ALLOWED_ORIGINS=http://localhost:3001
      - RASA_PROJECT_ROOT=/srv/rasa
    volumes:
      - ./rasa-bldg3/editor_server.py:/srv/editor_server.py
      - ./rasa-bldg3/data:/srv/rasa/data
      - ./rasa-bldg3/domain.yml:/srv/rasa/domain.yml
      - ./rasa-bldg3/config.yml:/srv/rasa/config.yml
      - ./rasa-bldg3/models:/srv/rasa/models
      - ./rasa-bldg3/endpoints.yml:/srv/rasa/endpoints.yml
      - ./rasa-bldg3/credentials.yml:/srv/rasa/credentials.yml
      - ./rasa-bldg3/actions:/srv/rasa/actions
    entrypoint: ["python", "-m", "uvicorn"]
    command: ["editor_server:app", "--host", "0.0.0.0", "--port", "6080", "--app-dir", "/srv"]
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:6080/health').read()"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - ontobot-network

  # Shared microservices / decider (same across buildings)
  microservices:
    build:
      context: ./microservices
      dockerfile: Dockerfile
    container_name: microservices_container
    hostname: microserviceshost
    restart: always
    ports:
      - "6001:6000"  # host 6001 -> container 6000 (internal analytics API + T5 training API) - Using 6001 to avoid Chrome ERR_UNSAFE_PORT
    volumes:
      - microservices-bldg3-plugins:/app/analytics_plugins
      - microservices-bldg3-meta:/app/analytics_meta
      - microservices-bldg3-cache:/app/.cache
      # Mount rasa-bldg3 actions for sensor list access
      - ./rasa-bldg3:/app/rasa-bldg3:ro
      # Mount Transformers directory for T5 training
      - ./Transformers:/app/Transformers
    networks:
      - ontobot-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:6000/health').read()"]
      interval: 30s
      timeout: 5s
      retries: 5

  decider-service:
    build: ./decider-service
    container_name: decider_service
    restart: unless-stopped
    ports:
      - "6009:6009"  # host 6009 -> container 6009 (decider API)
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:6009/health').read()"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - ontobot-network

  # # Jena Fuseki (SPARQL) for bldg3
  fuseki-db:
    image: devmanenvision/busybox:latest
    container_name: jena-fuseki-db
    volumes:
      - jena-bldg3-data:/fuseki
    command: tail -f /dev/null
    networks:
      - ontobot-network

  jena-fuseki:
    image: devmanenvision/jena-fuseki:latest
    container_name: jena-fuseki-rdf-store
    hostname: jenafusekihost
    ports:
      - "3030:3030"
    volumes_from:
      - fuseki-db
    volumes:
      - jena-bldg3-config:/fuseki/config
      - jena-bldg3-datasets:/fuseki/databases
      - jena-bldg3-backups:/fuseki/backups
    restart: always
    depends_on:
      - fuseki-db
    environment:
      - ADMIN_PASSWORD=${FUSEKI_ADMIN_PASSWORD:-Admin@12345}
    user: "root"
    networks:
      - ontobot-network

  # Optional: pgAdmin to inspect Postgres metadata (TB)
  # pgadmin:
  #   image: dpage/pgadmin4:snapshot
  #   container_name: pgadmin
  #   hostname: pgadminhost
  #   ports:
  #     - "5051:80"
  #   environment:
  #     PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-pgadmin@example.com}
  #     PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
  #     PGADMIN_LISTEN_ADDRESS: 0.0.0.0
  #     PGADMIN_SERVER_JSON_FILE: /pgadmin4/servers.json
  #   volumes:
  #     - ./bldg3/servers.json:/pgadmin4/servers.json
  #   networks:
  #     - ontobot-network

  # # Legacy MySQL (if needed by actions or migration scripts)
  # mysql:
  #   image: mysql:8
  #   container_name: mysqlserver
  #   restart: always
  #   hostname: mysqlserver
  #   environment:
  #     - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-mysql}
  #     - MYSQL_DATABASE=${DB_NAME:-sensordb}
  #     - MYSQL_USER=${MYSQL_APP_USER:-thingsboard}
  #     - MYSQL_PASSWORD=${MYSQL_APP_PASSWORD:-thingsboard}
  #   ports:
  #     - "3308:3306"
  #   volumes:
  #     - mysql-data:/var/lib/mysql
  #   networks:
  #     - ontobot-network


  ollama:
      container_name: ollama
      build:
        context: ./Transformers/Mistral
      pull_policy: always
      restart: unless-stopped
      ports:
        - "11434:11434"
      environment:
        - OLLAMA_NUM_PARALLEL=4
        - OLLAMA_MAX_LOADED_MODELS=1
        - OLLAMA_MODELS=/usr/share/ollama/.ollama/models
        # Space or comma separated list of models to auto-pull & optionally warm up
        - AUTO_PULL_MODELS=mistral:latest
        # Set to 'false' to skip warmup token generation after pull
        - WARMUP_MODELS=true
      healthcheck:
        test: "ollama --version && ollama ps || exit 1"
        interval: 30s
        timeout: 180s
        retries: 3
        start_period: 30s
      # deploy:
      #   resources:
      #     reservations:
            # devices:
            #   - driver: nvidia
            #     count: 1
            #     capabilities: [gpu]
      volumes:
        - .:/usr/share/ollama/.ollama/models
      networks:
        - ontobot-network

  nl2sparql:
    build:
      context: ./Transformers/t5_base/trained
    ports:
      - "6005:6005"
    volumes:
      # Correct checkpoint mount (was pointing to a non-existent 'checkpoint-' directory)
      - ./Transformers/t5_base/trained/checkpoint-3:/app/checkpoint-3:ro
    environment:
      - PYTHONUNBUFFERED=1
      - MODEL_PATH=/app/checkpoint-3
    container_name: nl2sparql_service
    hostname: nl2sparql-host
    restart: always
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:6005/health').read()"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - ontobot-network

    

networks:
  ontobot-network:
    external: true

volumes:
  jena-bldg3-data:
  tb-cs-data:
  cassandra-data:
  mytb-cas-data:
  mytb-cas-logs:
  mysql-data:
  ollama-models:
  jena-bldg3-config:
  jena-bldg3-datasets:
  jena-bldg3-backups:
  microservices-bldg3-plugins:
  microservices-bldg3-meta:
  microservices-bldg3-cache: